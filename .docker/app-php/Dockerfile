ARG DOCKER_IMAGE_VERSION=master
ARG DOCKER_SERVER_HOST
ARG DOCKER_PROJECT_PATH
ARG DOCKER_PHP_VERSION
ARG DOCKER_SERVER_PORT
ARG APP_ENV=prod

FROM ${DOCKER_SERVER_HOST}:${DOCKER_SERVER_PORT}/${DOCKER_PROJECT_PATH}/app-${APP_ENV}:${DOCKER_IMAGE_VERSION} AS app
FROM ${DOCKER_SERVER_HOST}:${DOCKER_SERVER_PORT}/${DOCKER_PROJECT_PATH}/php${DOCKER_PHP_VERSION}-fpm:${DOCKER_IMAGE_VERSION}

COPY --from=app /app /app

RUN chown -R www-data /app

WORKDIR /app
STOPSIGNAL SIGINT
RUN chmod +x /app/.docker/app-php/entrypoint.sh
ENTRYPOINT ["/app/.docker/app-php/entrypoint.sh"]
CMD ["php-fpm"]
